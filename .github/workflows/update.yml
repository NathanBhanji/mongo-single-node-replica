name: 🔄 Update Stackbrew Library

on:
  schedule:
    - cron: "0 0 * * *" # Run daily at midnight UTC
  workflow_dispatch: # Allow manual triggering

jobs:
  update-library:
    runs-on: ubuntu-latest
    steps:
      - name: 🛒 Checkout repository
        uses: actions/checkout@v4

      - name: 📦 Install jq
        run: sudo apt-get install -y jq

      - name: 🚀 Run update script and generate library file
        run: |
          ./update.sh
          ./generate-stackbrew-library.sh > libraryfile

      - name: 🔍 Check for changes and analyze
        id: git-check
        run: |
          if ! git diff --exit-code libraryfile; then
            changes=$(git diff --unified=0 libraryfile | grep '^[+-]' | grep -v '^[+-]\{3\}')
            summary=$(echo "$changes" | awk -F':' '{print $1}' | sort | uniq | head -n 3 | tr '\n' ',' | sed 's/,$//')
            echo "summary=$summary" >> $GITHUB_OUTPUT
          fi

      - name: 🚢 Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "Update: ${{ steps.git-check.outputs.summary }}"
          title: "Update: ${{ steps.git-check.outputs.summary }}"
          body: |
            This PR updates the stackbrew library file with the following changes:

            ```diff
            ${{ steps.git-check.outputs.changes }}
            ```

            Auto-generated by GitHub Actions.
          branch: update-stackbrew-library
          delete-branch: true
